{
  "name": "å‘Šè­¦è‡ªåŠ¨åŒ–å·¥ä½œæµ - Prometheus + Jira + é£ä¹¦",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Prometheus Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{$json.status}}",
              "rightValue": "firing",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-firing",
      "name": "åˆ¤æ–­å‘Šè­¦çŠ¶æ€",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// è§£æPrometheuså‘Šè­¦æ•°æ®\nconst alerts = $json.alerts || [];\nconst processedAlerts = [];\n\nfor (const alert of alerts) {\n  const severity = alert.labels.severity || 'unknown';\n  const alertname = alert.labels.alertname || 'Unknown Alert';\n  const instance = alert.labels.instance || 'unknown';\n  const description = alert.annotations.description || alert.annotations.summary || 'No description';\n  \n  // ç¡®å®šè´£ä»»äºº\n  let assignee = 'devops-team@company.com';\n  const team = alert.labels.team;\n  \n  if (team === 'infrastructure') {\n    assignee = 'infrastructure-team@company.com';\n  } else if (team === 'application') {\n    assignee = 'dev-team@company.com';\n  } else if (team === 'platform') {\n    assignee = 'platform-team@company.com';\n  }\n  \n  // ç¡®å®šä¼˜å…ˆçº§\n  let priority = 'Medium';\n  if (severity === 'critical') {\n    priority = 'High';\n  } else if (severity === 'warning') {\n    priority = 'Medium';\n  }\n  \n  processedAlerts.push({\n    alertname,\n    severity,\n    instance,\n    description,\n    assignee,\n    priority,\n    team: team || 'devops',\n    timestamp: alert.startsAt,\n    fingerprint: alert.fingerprint\n  });\n}\n\nreturn processedAlerts.map(alert => ({ json: alert }));"
      },
      "id": "process-alerts",
      "name": "å¤„ç†å‘Šè­¦æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "url": "https://your-jira-instance.atlassian.net/rest/api/3/issue",
        "options": {
          "headers": {
            "Content-Type": "application/json"
          }
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"fields\": {\n    \"project\": {\n      \"key\": \"OPS\"\n    },\n    \"summary\": \"[{{$json.severity.toUpperCase()}}] {{$json.alertname}} - {{$json.instance}}\",\n    \"description\": {\n      \"type\": \"doc\",\n      \"version\": 1,\n      \"content\": [\n        {\n          \"type\": \"paragraph\",\n          \"content\": [\n            {\n              \"type\": \"text\",\n              \"text\": \"å‘Šè­¦è¯¦æƒ…:\\n{{$json.description}}\\n\\nå®ä¾‹: {{$json.instance}}\\nä¸¥é‡ç¨‹åº¦: {{$json.severity}}\\nå›¢é˜Ÿ: {{$json.team}}\\næ—¶é—´: {{$json.timestamp}}\"\n            }\n          ]\n        }\n      ]\n    },\n    \"issuetype\": {\n      \"name\": \"Bug\"\n    },\n    \"priority\": {\n      \"name\": \"{{$json.priority}}\"\n    },\n    \"assignee\": {\n      \"emailAddress\": \"{{$json.assignee}}\"\n    },\n    \"labels\": [\"monitoring\", \"prometheus\", \"{{$json.severity}}\", \"{{$json.team}}\"]\n  }\n}"
      },
      "id": "create-jira-ticket",
      "name": "åˆ›å»ºJiraå·¥å•",\n      "type": "n8n-nodes-base.httpRequest",\n      "typeVersion": 4,\n      "position": [900, 200],\n      "credentials": {\n        \"httpBasicAuth\": {\n          \"id\": \"jira-auth\",\n          \"name\": \"Jira Basic Auth\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        },\n        \"sendBody\": true,\n        \"bodyContentType\": \"json\",\n        \"jsonBody\": \"={\\n  \\\"msg_type\\\": \\\"interactive\\\",\\n  \\\"card\\\": {\\n    \\\"config\\\": {\\n      \\\"wide_screen_mode\\\": true\\n    },\\n    \\\"elements\\\": [\\n      {\\n        \\\"tag\\\": \\\"div\\\",\\n        \\\"text\\\": {\\n          \\\"content\\\": \\\"ğŸš¨ **å‘Šè­¦é€šçŸ¥** ğŸš¨\\\\n\\\\n**å‘Šè­¦åç§°**: {{$json.alertname}}\\\\n**ä¸¥é‡ç¨‹åº¦**: {{$json.severity}}\\\\n**å½±å“å®ä¾‹**: {{$json.instance}}\\\\n**è´£ä»»å›¢é˜Ÿ**: {{$json.team}}\\\\n**è´£ä»»äºº**: {{$json.assignee}}\\\\n\\\\n**è¯¦ç»†æè¿°**:\\\\n{{$json.description}}\\\\n\\\\n**å¤„ç†çŠ¶æ€**: å·²è‡ªåŠ¨åˆ›å»ºJiraå·¥å•\\\\n**å·¥å•é“¾æ¥**: [æŸ¥çœ‹å·¥å•](https://your-jira-instance.atlassian.net/browse/{{$('create-jira-ticket').item.json.key}})\\\",\\n          \\\"tag\\\": \\\"lark_md\\\"\\n        }\\n      },\\n      {\\n        \\\"actions\\\": [\\n          {\\n            \\\"tag\\\": \\\"button\\\",\\n            \\\"text\\\": {\\n              \\\"content\\\": \\\"æŸ¥çœ‹Grafana\\\",\\n              \\\"tag\\\": \\\"lark_md\\\"\\n            },\\n            \\\"url\\\": \\\"https://grafana.local:3000\\\",\\n            \\\"type\\\": \\\"default\\\"\\n          },\\n          {\\n            \\\"tag\\\": \\\"button\\\",\\n            \\\"text\\\": {\\n              \\\"content\\\": \\\"æŸ¥çœ‹Prometheus\\\",\\n              \\\"tag\\\": \\\"lark_md\\\"\\n            },\\n            \\\"url\\\": \\\"https://prometheus.local:9090\\\",\\n            \\\"type\\\": \\\"default\\\"\\n          }\\n        ],\\n        \\\"tag\\\": \\\"action\\\"\\n      }\\n    ],\\n    \\\"header\\\": {\\n      \\\"title\\\": {\\n        \\\"content\\\": \\\"ğŸ”¥ {{$json.severity.toUpperCase()}} çº§åˆ«å‘Šè­¦\\\",\\n        \\\"tag\\\": \\\"plain_text\\\"\\n      },\\n      \\\"template\\\": \\\"{{$json.severity === 'critical' ? 'red' : 'orange'}}\\\"\\n    }\\n  }\\n}\"\n      },\n      \"id\": \"send-feishu-notification\",\n      \"name\": \"å‘é€é£ä¹¦é€šçŸ¥\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 400]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://prometheus:9090/api/v1/alerts\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        }\n      },\n      \"id\": \"check-alert-status\",\n      \"name\": \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={\\n  \\\"status\\\": \\\"success\\\",\\n  \\\"message\\\": \\\"Alert processed successfully\\\",\\n  \\\"jira_ticket\\\": \\\"{{$('create-jira-ticket').item.json.key}}\\\",\\n  \\\"processed_alerts\\\": {{$('process-alerts').item.json.length}}\\n}\"\n      },\n      \"id\": \"response-node\",\n      \"name\": \"å“åº”ç»“æœ\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1,\n      \"position\": [1340, 300]\n    },\n    {\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"hours\",\n              \"hoursInterval\": 1\n            }\n          ]\n        }\n      },\n      \"id\": \"schedule-check\",\n      \"name\": \"å®šæ—¶æ£€æŸ¥ä»»åŠ¡\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"typeVersion\": 1,\n      \"position\": [240, 600]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://your-jira-instance.atlassian.net/rest/api/3/search\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          },\n          \"qs\": {\n            \"jql\": \"project = OPS AND labels = monitoring AND status != Done AND created >= -24h\"\n          }\n        }\n      },\n      \"id\": \"check-open-tickets\",\n      \"name\": \"æ£€æŸ¥å¾…å¤„ç†å·¥å•\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [460, 600],\n      \"credentials\": {\n        \"httpBasicAuth\": {\n          \"id\": \"jira-auth\",\n          \"name\": \"Jira Basic Auth\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{$json.total}}\",\n              \"rightValue\": 5,\n              \"operator\": {\n                \"type\": \"number\",\n                \"operation\": \"gt\"\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        }\n      },\n      \"id\": \"check-ticket-count\",\n      \"name\": \"æ£€æŸ¥å·¥å•æ•°é‡\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 1,\n      \"position\": [680, 600]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        },\n        \"sendBody\": true,\n        \"bodyContentType\": \"json\",\n        \"jsonBody\": \"={\\n  \\\"msg_type\\\": \\\"text\\\",\\n  \\\"content\\\": {\\n    \\\"text\\\": \\\"ğŸ“Š **è¿ç»´å·¥å•ç»Ÿè®¡æŠ¥å‘Š**\\\\n\\\\nå½“å‰å¾…å¤„ç†ç›‘æ§ç›¸å…³å·¥å•æ•°é‡: {{$json.total}}\\\\n\\\\nâš ï¸ å·¥å•æ•°é‡è¾ƒå¤šï¼Œè¯·åŠæ—¶å¤„ç†ä»¥ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚\\\\n\\\\nğŸ”— [æŸ¥çœ‹æ‰€æœ‰å·¥å•](https://your-jira-instance.atlassian.net/issues/?jql=project%20%3D%20OPS%20AND%20labels%20%3D%20monitoring%20AND%20status%20!%3D%20Done)\\\"\n  }\n}\"\n      },\n      \"id\": \"send-summary-notification\",\n      \"name\": \"å‘é€æ±‡æ€»é€šçŸ¥\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 600]\n    }\n  ],\n  \"connections\": {\n    \"Prometheus Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"åˆ¤æ–­å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"åˆ¤æ–­å‘Šè­¦çŠ¶æ€\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å¤„ç†å‘Šè­¦æ•°æ®\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å¤„ç†å‘Šè­¦æ•°æ®\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"åˆ›å»ºJiraå·¥å•\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"å‘é€é£ä¹¦é€šçŸ¥\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"åˆ›å»ºJiraå·¥å•\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å‘é€é£ä¹¦é€šçŸ¥\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å“åº”ç»“æœ\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å®šæ—¶æ£€æŸ¥ä»»åŠ¡\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å¾…å¤„ç†å·¥å•\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å¾…å¤„ç†å·¥å•\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å·¥å•æ•°é‡\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å·¥å•æ•°é‡\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å‘é€æ±‡æ€»é€šçŸ¥\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": true,\n  \"settings\": {\n    \"timezone\": \"Asia/Shanghai\"\n  },\n  \"versionId\": \"1\"\n}"
        }
      ],\n      \"position\": [900, 600]\n    }\n  ],\n  \"connections\": {\n    \"Prometheus Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"åˆ¤æ–­å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"åˆ¤æ–­å‘Šè­¦çŠ¶æ€\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å¤„ç†å‘Šè­¦æ•°æ®\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å¤„ç†å‘Šè­¦æ•°æ®\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"åˆ›å»ºJiraå·¥å•\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"å‘é€é£ä¹¦é€šçŸ¥\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"åˆ›å»ºJiraå·¥å•\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å‘é€é£ä¹¦é€šçŸ¥\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å‘Šè­¦çŠ¶æ€\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å“åº”ç»“æœ\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"å®šæ—¶æ£€æŸ¥ä»»åŠ¡\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å¾…å¤„ç†å·¥å•\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å¾…å¤„ç†å·¥å•\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"æ£€æŸ¥å·¥å•æ•°é‡\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"æ£€æŸ¥å·¥å•æ•°é‡\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"å‘é€æ±‡æ€»é€šçŸ¥\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": true,\n  \"settings\": {\n    \"timezone\": \"Asia/Shanghai\"\n  },\n  \"versionId\": \"1\"\n}