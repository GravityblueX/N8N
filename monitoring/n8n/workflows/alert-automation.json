{
  "name": "告警自动化工作流 - Prometheus + Jira + 飞书",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Prometheus Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{$json.status}}",
              "rightValue": "firing",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-firing",
      "name": "判断告警状态",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// 解析Prometheus告警数据\nconst alerts = $json.alerts || [];\nconst processedAlerts = [];\n\nfor (const alert of alerts) {\n  const severity = alert.labels.severity || 'unknown';\n  const alertname = alert.labels.alertname || 'Unknown Alert';\n  const instance = alert.labels.instance || 'unknown';\n  const description = alert.annotations.description || alert.annotations.summary || 'No description';\n  \n  // 确定责任人\n  let assignee = 'devops-team@company.com';\n  const team = alert.labels.team;\n  \n  if (team === 'infrastructure') {\n    assignee = 'infrastructure-team@company.com';\n  } else if (team === 'application') {\n    assignee = 'dev-team@company.com';\n  } else if (team === 'platform') {\n    assignee = 'platform-team@company.com';\n  }\n  \n  // 确定优先级\n  let priority = 'Medium';\n  if (severity === 'critical') {\n    priority = 'High';\n  } else if (severity === 'warning') {\n    priority = 'Medium';\n  }\n  \n  processedAlerts.push({\n    alertname,\n    severity,\n    instance,\n    description,\n    assignee,\n    priority,\n    team: team || 'devops',\n    timestamp: alert.startsAt,\n    fingerprint: alert.fingerprint\n  });\n}\n\nreturn processedAlerts.map(alert => ({ json: alert }));"
      },
      "id": "process-alerts",
      "name": "处理告警数据",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "url": "https://your-jira-instance.atlassian.net/rest/api/3/issue",
        "options": {
          "headers": {
            "Content-Type": "application/json"
          }
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"fields\": {\n    \"project\": {\n      \"key\": \"OPS\"\n    },\n    \"summary\": \"[{{$json.severity.toUpperCase()}}] {{$json.alertname}} - {{$json.instance}}\",\n    \"description\": {\n      \"type\": \"doc\",\n      \"version\": 1,\n      \"content\": [\n        {\n          \"type\": \"paragraph\",\n          \"content\": [\n            {\n              \"type\": \"text\",\n              \"text\": \"告警详情:\\n{{$json.description}}\\n\\n实例: {{$json.instance}}\\n严重程度: {{$json.severity}}\\n团队: {{$json.team}}\\n时间: {{$json.timestamp}}\"\n            }\n          ]\n        }\n      ]\n    },\n    \"issuetype\": {\n      \"name\": \"Bug\"\n    },\n    \"priority\": {\n      \"name\": \"{{$json.priority}}\"\n    },\n    \"assignee\": {\n      \"emailAddress\": \"{{$json.assignee}}\"\n    },\n    \"labels\": [\"monitoring\", \"prometheus\", \"{{$json.severity}}\", \"{{$json.team}}\"]\n  }\n}"
      },
      "id": "create-jira-ticket",
      "name": "创建Jira工单",\n      "type": "n8n-nodes-base.httpRequest",\n      "typeVersion": 4,\n      "position": [900, 200],\n      "credentials": {\n        \"httpBasicAuth\": {\n          \"id\": \"jira-auth\",\n          \"name\": \"Jira Basic Auth\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        },\n        \"sendBody\": true,\n        \"bodyContentType\": \"json\",\n        \"jsonBody\": \"={\\n  \\\"msg_type\\\": \\\"interactive\\\",\\n  \\\"card\\\": {\\n    \\\"config\\\": {\\n      \\\"wide_screen_mode\\\": true\\n    },\\n    \\\"elements\\\": [\\n      {\\n        \\\"tag\\\": \\\"div\\\",\\n        \\\"text\\\": {\\n          \\\"content\\\": \\\"🚨 **告警通知** 🚨\\\\n\\\\n**告警名称**: {{$json.alertname}}\\\\n**严重程度**: {{$json.severity}}\\\\n**影响实例**: {{$json.instance}}\\\\n**责任团队**: {{$json.team}}\\\\n**责任人**: {{$json.assignee}}\\\\n\\\\n**详细描述**:\\\\n{{$json.description}}\\\\n\\\\n**处理状态**: 已自动创建Jira工单\\\\n**工单链接**: [查看工单](https://your-jira-instance.atlassian.net/browse/{{$('create-jira-ticket').item.json.key}})\\\",\\n          \\\"tag\\\": \\\"lark_md\\\"\\n        }\\n      },\\n      {\\n        \\\"actions\\\": [\\n          {\\n            \\\"tag\\\": \\\"button\\\",\\n            \\\"text\\\": {\\n              \\\"content\\\": \\\"查看Grafana\\\",\\n              \\\"tag\\\": \\\"lark_md\\\"\\n            },\\n            \\\"url\\\": \\\"https://grafana.local:3000\\\",\\n            \\\"type\\\": \\\"default\\\"\\n          },\\n          {\\n            \\\"tag\\\": \\\"button\\\",\\n            \\\"text\\\": {\\n              \\\"content\\\": \\\"查看Prometheus\\\",\\n              \\\"tag\\\": \\\"lark_md\\\"\\n            },\\n            \\\"url\\\": \\\"https://prometheus.local:9090\\\",\\n            \\\"type\\\": \\\"default\\\"\\n          }\\n        ],\\n        \\\"tag\\\": \\\"action\\\"\\n      }\\n    ],\\n    \\\"header\\\": {\\n      \\\"title\\\": {\\n        \\\"content\\\": \\\"🔥 {{$json.severity.toUpperCase()}} 级别告警\\\",\\n        \\\"tag\\\": \\\"plain_text\\\"\\n      },\\n      \\\"template\\\": \\\"{{$json.severity === 'critical' ? 'red' : 'orange'}}\\\"\\n    }\\n  }\\n}\"\n      },\n      \"id\": \"send-feishu-notification\",\n      \"name\": \"发送飞书通知\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 400]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://prometheus:9090/api/v1/alerts\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        }\n      },\n      \"id\": \"check-alert-status\",\n      \"name\": \"检查告警状态\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={\\n  \\\"status\\\": \\\"success\\\",\\n  \\\"message\\\": \\\"Alert processed successfully\\\",\\n  \\\"jira_ticket\\\": \\\"{{$('create-jira-ticket').item.json.key}}\\\",\\n  \\\"processed_alerts\\\": {{$('process-alerts').item.json.length}}\\n}\"\n      },\n      \"id\": \"response-node\",\n      \"name\": \"响应结果\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1,\n      \"position\": [1340, 300]\n    },\n    {\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"hours\",\n              \"hoursInterval\": 1\n            }\n          ]\n        }\n      },\n      \"id\": \"schedule-check\",\n      \"name\": \"定时检查任务\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"typeVersion\": 1,\n      \"position\": [240, 600]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://your-jira-instance.atlassian.net/rest/api/3/search\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          },\n          \"qs\": {\n            \"jql\": \"project = OPS AND labels = monitoring AND status != Done AND created >= -24h\"\n          }\n        }\n      },\n      \"id\": \"check-open-tickets\",\n      \"name\": \"检查待处理工单\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [460, 600],\n      \"credentials\": {\n        \"httpBasicAuth\": {\n          \"id\": \"jira-auth\",\n          \"name\": \"Jira Basic Auth\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{$json.total}}\",\n              \"rightValue\": 5,\n              \"operator\": {\n                \"type\": \"number\",\n                \"operation\": \"gt\"\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        }\n      },\n      \"id\": \"check-ticket-count\",\n      \"name\": \"检查工单数量\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 1,\n      \"position\": [680, 600]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token\",\n        \"options\": {\n          \"headers\": {\n            \"Content-Type\": \"application/json\"\n          }\n        },\n        \"sendBody\": true,\n        \"bodyContentType\": \"json\",\n        \"jsonBody\": \"={\\n  \\\"msg_type\\\": \\\"text\\\",\\n  \\\"content\\\": {\\n    \\\"text\\\": \\\"📊 **运维工单统计报告**\\\\n\\\\n当前待处理监控相关工单数量: {{$json.total}}\\\\n\\\\n⚠️ 工单数量较多，请及时处理以确保系统稳定性。\\\\n\\\\n🔗 [查看所有工单](https://your-jira-instance.atlassian.net/issues/?jql=project%20%3D%20OPS%20AND%20labels%20%3D%20monitoring%20AND%20status%20!%3D%20Done)\\\"\n  }\n}\"\n      },\n      \"id\": \"send-summary-notification\",\n      \"name\": \"发送汇总通知\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4,\n      \"position\": [900, 600]\n    }\n  ],\n  \"connections\": {\n    \"Prometheus Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"判断告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"判断告警状态\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"处理告警数据\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"处理告警数据\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"创建Jira工单\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"发送飞书通知\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"创建Jira工单\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"发送飞书通知\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查告警状态\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"响应结果\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"定时检查任务\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查待处理工单\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查待处理工单\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查工单数量\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查工单数量\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"发送汇总通知\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": true,\n  \"settings\": {\n    \"timezone\": \"Asia/Shanghai\"\n  },\n  \"versionId\": \"1\"\n}"
        }
      ],\n      \"position\": [900, 600]\n    }\n  ],\n  \"connections\": {\n    \"Prometheus Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"判断告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"判断告警状态\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"处理告警数据\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"处理告警数据\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"创建Jira工单\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"发送飞书通知\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"创建Jira工单\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"发送飞书通知\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查告警状态\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查告警状态\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"响应结果\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"定时检查任务\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查待处理工单\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查待处理工单\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"检查工单数量\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"检查工单数量\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"发送汇总通知\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": true,\n  \"settings\": {\n    \"timezone\": \"Asia/Shanghai\"\n  },\n  \"versionId\": \"1\"\n}